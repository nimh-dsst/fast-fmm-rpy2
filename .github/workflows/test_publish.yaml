name: Publish to PyPI

on:
  push:
    branches:
      - 'fix-ghas'
    # paths:
    #   - '.github/workflows/test_publish.yaml'

jobs:
  pypi:
    runs-on: ubuntu-latest
    # IMPORTANT: this permission is mandatory for Trusted Publishing
    permissions:
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.x
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Setup uv
        uses: astral-sh/setup-uv@v5
        with:
          version: "0.6.x"
          # python-version: "3.x"

      # R must be installed to test installation
      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Build package
        run: uv build

      - name: Test installation (wheel)
        run: uv run --isolated --no-project --python 3.13 --with dist/*.whl python -c "from fast_fmm_rpy2.ingest import read_csv_in_pandas_pass_to_r; print('Success!')"

      - name: Test installation (source distribution)
        run: uv run --isolated --no-project --python 3.13 --with dist/*.tar.gz python -c "from fast_fmm_rpy2.ingest import read_csv_in_pandas_pass_to_r; print('Success!')"

      - name: Publish package
        run: |
          # uv build
          uv publish --publish-url https://test.pypi.org/legacy/ --trusted-publishing always
